<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Restore</title>
    <link rel="stylesheet" href="hue-callionica.css">
    <style>
        .limit {
            color: lightgray;
        }
        .numeric {
            text-align: right;
        }
        td:first-of-type {
            padding: 0;
        }
        a {
            background: none;
            text-decoration: underline;
        }
        #bridge-data {
            display: none;
        }
        tr[data-type='heading'] {
            color: gray;
            text-transform: uppercase;
        }
        tr[data-type='heading'] td {
            padding-top: 0.75rem;
        }
        tr[data-type='labels'] {
            font-weight: bold;
        }
        td[data-type='label'] {
            font-weight: bold;
        }
        td[data-type='label']::after {
            font-weight: bold;
            content: ':';
        }
    </style>
    <script type="module">
        import { loadCurrentBridge, loadConnection } from "./hue-callionica-connect.js";
        import { sortBy, getAll, getAllCategories, getCapabilities, getSceneComplete } from "./hue-callionica.js";
        import { localizeDateTime } from "./hue-callionica-ui.js";
        import * as Diff from "./hue-callionica-diff.js";

        let bridge;
        let connection;

        async function onload(name, text) {
            let source;
            
            try {
                source = JSON.parse(text);
            } catch (e) {
            }

            if (source === undefined) {
                alert(`${name} does not contain Hue bridge data or is corrupted.`);
            }

            const s_id = source.config?.bridgeid;

            if (s_id === undefined) {
                alert(`${name} does not contain Hue bridge data.`);
                return;
            }

            const destination = await getAll(connection);
            const d_id = destination.config?.bridgeid;

            if (s_id !== d_id) {
                const shouldContinue = confirm("Bridges are different. Continue?");
                if (!shouldContinue) {
                    return;
                }
            }

            const lights = Diff.lights({ source, destination });

            // const lightsTable = Diff.lightsTable(lights);

            console.log(lights);

            const r = document.querySelector("#result");
            r.innerHTML = "<hr/>";

            const s_name = source.config?.name;
            const d_name = destination.config?.name;

            const s_time = new Date(source.config.UTC + "Z");
            const s_displayTime = localizeDateTime(s_time).display;
            const s_display = (s_name !== undefined) && (s_name === d_name) ? name : `${s_name} (${name})`;
            const tbl = Diff.propertyTable([
                ["Destination", destination.config.name],
                ["Source", s_display],
                ["Source Date", s_displayTime], 
            ]);

            const lightsTable = Diff.lightsTable(lights, tbl);

            r.append(lightsTable);

            // alert("RESTORING BRIDGE DATA IS NOT IMPLEMENTED");
        }

        async function main() {
            bridge = loadCurrentBridge();
            connection = await loadConnection("Callionica", bridge);

            const data = await getAll(connection);

            const p = document.querySelector("#bridge-data-proxy");
            const b = document.querySelector("#bridge-data");
            p.onclick = () => { b.value = null; b.click(); };
            b.onchange = (e) => {
                const file = e.target.files[0];
                if (file !== undefined) {
                    const fr = new FileReader();
                    fr.addEventListener("load", ()=>{ onload(file.name, fr.result); });
                    fr.readAsText(file);
                }
            };
        }

        async function _wrap(fn) {
            try {
                await fn();
                delete document.body.dataset.showConnection;
            } catch (error) {
                document.body.dataset.showConnection = true;

                const e = document.querySelector("#connection");

                if ((bridge === undefined) || (connection === undefined)) {
                    e.innerHTML = `<a href="hue-callionica-connect.html">Connect to your Hue bridge</a>`;
                } else {
                    e.innerHTML = `<a href="https://${connection.bridge.ip}/api/unauthenticated/config">Refresh your Hue bridge connection</a>`;
                }

                setTimeout(()=> _main(), 3*1000);
            }
        }

        _wrap(main).then(x => console.log("Done"));
    </script>
</head>
<body>
    <h1>Restore</h1>
    <p>NOT YET IMPLEMENTED!<!-- Here you can restore data and settings for this app or for the Hue bridge.--></p>
    <hr/>
    <div id="connection"></div>
    <div id="content">
        <!--<p><a id="app" download="app-data.json">Restore app data</a></p>
        <p><a id="app-connections" download="app-connections.json">Restore app connections</a></p>-->
        <table>
            <tr>
            <td><label for="bridge-data">Load Hue bridge data:</label></td>
            <td><button id="bridge-data-proxy">Choose file</button><input id="bridge-data" type="file" accept=".json,application/json"></td>
            </tr>
        </table>
    </div>
    <div id="result"></div>
    <hr/>
    <table>
        <tr><td><h4>Related</h4></td><td></td></tr>
        <tr><td><a href="hue-callionica-backup.html">Backup</a></td><td></td></tr>
    </table>
    <hr/>
    <p>IMPORTANT: Not all Hue bridge data can be restored. Backing up the Hue bridge data gives you <i>a chance</i> to see what has changed or been lost in the event of a problem, but there is no automatic mechanism to put all your lights, settings, groups, and scenes back the way they were.</p>
</body>
</html>
